<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RPP-742 Task-Based Effective Dose Assessment Worksheet</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .toggle-content {
            display: grid;
            grid-template-rows: 0fr;
            transition: grid-template-rows 0.4s ease-out;
        }
        .toggle-content > div {
            overflow: hidden;
        }
        .toggle-content.expanded {
            grid-template-rows: 1fr;
        }
        .toggle-label::after { content: "►"; display: inline-block; margin-left: 0.5rem; transition: transform 0.3s; }
        .toggle-label.expanded::after { transform: rotate(90deg); }
        .toggle-label:hover {
            background-color: #2563eb; /* Tailwind's blue-600 for hover effect */
        }
        input[type="number"]::-webkit-inner-spin-button, input[type="number"]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        input[type="number"] { -moz-appearance: textfield; }
        /* Outline text boxes and form elements for better visibility */
        input[type="text"], input[type="number"], input[type="date"], textarea, select {
            border: 2px solid #d1d5db !important;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06) !important;
        }
        input[type="text"]:focus, input[type="number"]:focus, input[type="date"]:focus, textarea:focus, select:focus {
            border-color: #3b82f6 !important;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1) !important;
        }
        .tab-content-pane { display: none; }
        .tab-content-pane.active { display: block; }
        
        .tab-button { transition: background-color 0.2s, color 0.2s; }
        .tab-button.task-tab-button {
            background-color: #fef3c7; /* A light yellow */
            color: #92400e;
            border-color: #fde68a;
        }
        .tab-button.task-tab-button:hover {
            background-color: #fde68a;
        }
        .tab-button.active { background-color: #3b82f6; color: white; border-color: #3b82f6; }

        @media print {
            body { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
            .no-print { display: none !important; }
            .printable-section, .tab-content-pane { display: block !important; page-break-before: always; }
            .toggle-content { display: block !important; grid-template-rows: 1fr !important; }
            .toggle-label::after, .tab-nav { display: none !important; }
            .bg-blue-700 { background-color: #1d4ed8 !important; }
            .text-white { color: white !important; }
        }
    </style>
</head>
<body class="bg-gray-100 font-sans">
    <div class="container mx-auto px-4 py-8 max-w-7xl">
        <!-- Header -->
        <header class="bg-blue-800 text-white rounded-lg shadow-lg mb-8 overflow-hidden">
            <div class="px-6 py-4 flex justify-between items-center">
                <div>
                    <h1 class="text-2xl md:text-3xl font-bold">RPP-742 Task-Based Dose Assessment</h1>
                    <p class="text-blue-200 mt-1">Dose Estimation Tool</p>
                </div>
                <div class="flex items-center space-x-2 no-print">
                    <input type="file" id="loadFile" class="hidden" accept=".json">
                    <button id="loadBtn" class="px-3 py-2 bg-blue-600 hover:bg-blue-500 rounded-md transition"><i class="fas fa-upload mr-2"></i>Load</button>
                    <button id="saveBtn" class="px-3 py-2 bg-blue-600 hover:bg-blue-500 rounded-md transition"><i class="fas fa-save mr-2"></i>Save</button>
                    <button id="printBtn" class="px-3 py-2 bg-white text-blue-800 rounded-md hover:bg-blue-100 transition"><i class="fas fa-print mr-2"></i>Print</button>
                </div>
            </div>
        </header>

        <!-- Project Information -->
        <div class="bg-white rounded-lg shadow-md mb-8 overflow-hidden printable-section">
            <div class="bg-blue-700 text-white px-4 py-3 font-semibold"><h2>Project Information</h2></div>
            <div class="p-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <input type="text" id="workOrder" placeholder="Work Control Document Number" class="project-info block w-full rounded-md border-gray-300 shadow-sm">
                    <input type="date" id="date" class="project-info block w-full rounded-md border-gray-300 shadow-sm" required>
                </div>
                <textarea id="description" rows="3" placeholder="Work Description*" class="project-info mt-4 block w-full rounded-md border-gray-300 shadow-sm" required></textarea>
            </div>
        </div>

        <!-- Tab Navigation -->
        <div class="mb-4 border-b border-gray-200 no-print">
            <nav id="tab-nav" class="flex space-x-2 items-center" aria-label="Tabs">
                <button id="addNewTaskBtn" class="px-4 py-2 text-sm font-medium text-white bg-green-600 rounded-md hover:bg-green-700"><i class="fas fa-plus mr-2"></i>Add New Task</button>
            </nav>
        </div>

        <!-- Tab Content Area -->
        <div id="tab-content-area">
            <div id="empty-state" class="text-center py-16 bg-white rounded-lg shadow-md"><i class="fas fa-tasks fa-3x text-gray-400 mb-4"></i><h2 class="text-xl font-semibold text-gray-700">No Tasks Added Yet</h2><p class="text-gray-500 mt-2">Click the "Add New Task" button to begin.</p></div>
            <div id="summary-content" class="tab-content-pane printable-section">
                <!-- Summary Content will be populated by template -->
            </div>
        </div>
    </div>

    <!-- Templates (Hidden) -->
    <template id="summary-template">
        <div class="bg-white rounded-lg shadow-md mb-8 overflow-hidden"><div class="bg-blue-700 text-white px-4 py-3 font-semibold"><h2>Job Summary & Totals</h2></div><div class="toggle-content expanded"><div><div class="p-6"><h3 class="text-lg font-medium text-gray-800 mb-4">Dose Summary by Task</h3><div class="overflow-x-auto"><table class="min-w-full divide-y divide-gray-200"><thead class="bg-gray-50"><tr><th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Task</th><th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Location</th><th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"># Workers</th><th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">DAC Fraction</th><th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ind. External (mrem)</th><th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ind. Internal (mrem)</th><th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ind. Extremity/Skin (mrem)</th><th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Collective External (mrem)</th><th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Collective Internal (mrem)</th><th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Total Ind. Dose (mrem)</th></tr></thead><tbody id="summary-table-body" class="bg-white divide-y divide-gray-200"><tr id="no-tasks-row"><td colspan="10" class="px-4 py-4 text-center text-gray-500">No tasks added.</td></tr></tbody></table></div><h3 class="text-lg font-medium text-gray-800 mt-6 mb-4">Total Individual Dose Estimate</h3><div class="grid grid-cols-1 md:grid-cols-2 gap-4"><div class="p-4 bg-blue-50 rounded-lg"><label class="block text-sm font-bold text-blue-800">Total Estimated Effective Dose Per Individual (mrem)</label><input id="total-individual-dose-per-worker" type="text" class="mt-1 block w-full bg-blue-100 text-blue-900 font-bold text-lg rounded-md border-blue-300" readonly></div><div class="p-4 bg-purple-50 rounded-lg"><label class="block text-sm font-bold text-purple-800">Total Estimated Extremity/Skin Dose Per Individual (mrem)</label><input id="total-individual-extremity-dose-per-worker" type="text" class="mt-1 block w-full bg-purple-100 text-purple-900 font-bold text-lg rounded-md border-purple-300" readonly></div></div></div></div></div></div>
        <div class="bg-white rounded-lg shadow-md mb-8 overflow-hidden"><div class="bg-blue-700 text-white px-4 py-3 font-semibold flex justify-between items-center cursor-pointer toggle-label" onclick="toggleSection(this)"><h2>Workplace Air Sampling Triggers</h2></div><div class="toggle-content"><div><div class="p-6"><div class="space-y-4">
            <div class="flex items-start"><div class="flex items-center h-5"><input id="sampling-1" type="checkbox" class="air-sampling-check h-4 w-4" onchange="updateChecklistAlerts()"></div><div class="ml-3 text-sm"><label for="sampling-1" class="font-medium text-gray-700">Any time a worker is likely to exceed 40 DAC-hours per year (air sampling must be representative of breathing zone).</label></div></div>
            <div class="flex items-start"><div class="flex items-center h-5"><input id="sampling-2" type="checkbox" class="air-sampling-check h-4 w-4" onchange="updateChecklistAlerts()"></div><div class="ml-3 text-sm"><label for="sampling-2" class="font-medium text-gray-700">Any time respiratory protection devices have been prescribed (air sampling must be representative of breathing zone).</label></div></div>
            <div class="flex items-start"><div class="flex items-center h-5"><input id="sampling-3" type="checkbox" class="air-sampling-check h-4 w-4" onchange="updateChecklistAlerts()"></div><div class="ml-3 text-sm"><label for="sampling-3" class="font-medium text-gray-700">Any time an air sample is needed to estimate internal dose (air sampling must be representative of breathing zone).</label></div></div>
            <div class="flex items-start"><div class="flex items-center h-5"><input id="sampling-4" type="checkbox" class="air-sampling-check h-4 w-4" onchange="updateChecklistAlerts()"></div><div class="ml-3 text-sm"><label for="sampling-4" class="font-medium text-gray-700">Any time a worker's estimated annual intake is expected to exceed 10% of the annual limit on intake (ALI) or 500 mrem.</label></div></div>
            <div class="flex items-start"><div class="flex items-center h-5"><input id="sampling-5" type="checkbox" class="air-sampling-check h-4 w-4" onchange="updateChecklistAlerts()"></div><div class="ml-3 text-sm"><label for="sampling-5" class="font-medium text-gray-700">Any time an estimated airborne concentration is expected to exceed 0.3 DAC averaged over 40 hours (i.e., greater than 12 DAC-hours in a week) or the estimated airborne concentration is expected to exceed 1 DAC at any time.</label></div></div>
            <div class="flex items-start"><div class="flex items-center h-5"><input id="cams-trigger" type="checkbox" class="air-sampling-check h-4 w-4" onchange="updateChecklistAlerts()"></div><div class="ml-3 text-sm"><label for="cams-trigger" class="font-medium text-gray-700">CAMs are required to be deployed any time a worker is likely to exceed 40 DAC-hours in a week.</label></div></div>
            <div class="flex items-start"><div class="flex items-center h-5"><input id="sampling-7" type="checkbox" class="air-sampling-check h-4 w-4" onchange="updateChecklistAlerts()"></div><div class="ml-3 text-sm"><label for="sampling-7" class="font-medium text-gray-700">At the conclusion of a job in order to de-post an Airborne Radioactivity Area.</label></div></div>
            <div class="flex items-start"><div class="flex items-center h-5"><input id="sampling-boundary" type="checkbox" class="air-sampling-check h-4 w-4" onchange="updateChecklistAlerts()"></div><div class="ml-3 text-sm"><label for="sampling-boundary" class="font-medium text-gray-700">At the boundary of an Airborne Radioactivity Area when: • There is no physical boundary (e.g. wall or door) confining the air space, and • It has not been verified that airflow is negative into the ARA.</label></div></div>
            <div class="flex items-start"><div class="flex items-center h-5"><input id="sampling-6" type="checkbox" class="air-sampling-check h-4 w-4" onchange="updateChecklistAlerts()"></div><div class="ml-3 text-sm"><label for="sampling-6" class="font-medium text-gray-700">During any work or operation known or expected to cause airborne radioactivity, such as grinding, welding, burning, cutting, hydrolazing, vacuuming, sweeping, use of compressed air, use of volatiles on contaminated equipment, or breaching a radioactive system.</label></div></div>
            <div class="flex items-start"><div class="flex items-center h-5"><input id="sampling-6b" type="checkbox" class="air-sampling-check h-4 w-4" onchange="updateChecklistAlerts()"></div><div class="ml-3 text-sm"><label for="sampling-6b" class="font-medium text-gray-700">During any work or operation that involves the use of engineering controls such as containment or localized ventilation, unless additional methods, such as retrospective air sampling, are utilized to verify adequacy of the engineering controls.</label></div></div>
            <div class="flex items-start"><div class="flex items-center h-5"><input id="sampling-8" type="checkbox" class="air-sampling-check h-4 w-4" onchange="updateChecklistAlerts()"></div><div class="ml-3 text-sm"><label for="sampling-8" class="font-medium text-gray-700">Any time the radiological safety officer (RSO) or designee deems necessary based on historical information, past work experience, or professional judgment.</label></div></div>
        </div><div class="mt-6"><div class="bg-red-50 border-l-4 border-red-400 p-4 flex items-start" id="airSamplingAlert" style="display: none;"><i class="fas fa-exclamation-circle text-red-500 mr-3"></i><p class="text-sm text-red-700"><span class="font-semibold">Air Sampling Required</span></p></div><div class="bg-green-50 border-l-4 border-green-400 p-4 flex items-start" id="noAirSamplingAlert"><i class="fas fa-check-circle text-green-500 mr-3"></i><p class="text-sm text-green-700"><span class="font-semibold">No Air Sampling Required</span></p></div></div></div></div></div></div>
        <div class="bg-white rounded-lg shadow-md mb-8 overflow-hidden"><div class="bg-blue-700 text-white px-4 py-3 font-semibold flex justify-between items-center cursor-pointer toggle-label" onclick="toggleSection(this)"><h2>ALARA Trigger Review</h2></div><div class="toggle-content"><div><div class="p-6"><div class="space-y-4">
            <div class="flex items-start"><div class="flex items-center h-5"><input id="alara-1" type="checkbox" class="alara-check h-4 w-4" onchange="updateChecklistAlerts()"></div><div class="ml-3 text-sm"><label for="alara-1" class="font-medium text-gray-700">Non-routine or complex work.</label></div></div>
            <div class="flex items-start"><div class="flex items-center h-5"><input id="alara-2" type="checkbox" class="alara-check h-4 w-4" onchange="updateChecklistAlerts()"></div><div class="ml-3 text-sm"><label for="alara-2" class="font-medium text-gray-700">Estimated individual total effective dose (TED) greater than 500 mrem per year or per job if less than one year (750 mrem per year or per job if less than one year for AGHCF).</label></div></div>
            <div class="flex items-start"><div class="flex items-center h-5"><input id="alara-3" type="checkbox" class="alara-check h-4 w-4" onchange="updateChecklistAlerts()"></div><div class="ml-3 text-sm"><label for="alara-3" class="font-medium text-gray-700">Estimated individual extremity or skin dose > 5000 mrem/year.</label></div></div>
            <div class="flex items-start"><div class="flex items-center h-5"><input id="alara-4" type="checkbox" class="alara-check h-4 w-4" onchange="updateChecklistAlerts()"></div><div class="ml-3 text-sm"><label for="alara-4" class="font-medium text-gray-700">Collective dose > 750 person-mrem per year.</label></div></div>
            <div class="flex items-start"><div class="flex items-center h-5"><input id="alara-5" type="checkbox" class="alara-check h-4 w-4" onchange="updateChecklistAlerts()"></div><div class="ml-3 text-sm"><label for="alara-5" class="font-medium text-gray-700">Anticipated airborne radioactivity greater than 200 DAC averaged over 1 hour or spike in excess of 1000 DAC.</label></div></div>
            <div class="flex items-start"><div class="flex items-center h-5"><input id="alara-6" type="checkbox" class="alara-check h-4 w-4" onchange="updateChecklistAlerts()"></div><div class="ml-3 text-sm"><label for="alara-6" class="font-medium text-gray-700">Removable contamination > 1000x Appendix D levels.</label></div></div>
            <div class="flex items-start"><div class="flex items-center h-5"><input id="alara-7" type="checkbox" class="alara-check h-4 w-4" onchange="updateChecklistAlerts()"></div><div class="ml-3 text-sm"><label for="alara-7" class="font-medium text-gray-700">Worker likely to receive an internal dose exceeding 100 mrem.</label></div></div>
            <div class="flex items-start"><div class="flex items-center h-5"><input id="alara-8" type="checkbox" class="alara-check h-4 w-4" onchange="updateChecklistAlerts()"></div><div class="ml-3 text-sm"><label for="alara-8" class="font-medium text-gray-700">Entry into areas with dose rates > 10 rem/hr at 30 cm.</label></div></div>
        </div><div class="mt-6"><div class="bg-red-50 border-l-4 border-red-400 p-4 flex items-start" id="alaraAlert" style="display: none;"><i class="fas fa-exclamation-circle text-red-500 mr-3"></i><p class="text-sm text-red-700"><span class="font-semibold">ALARA Review Required</span></p></div><div class="bg-green-50 border-l-4 border-green-400 p-4 flex items-start" id="noAlaraAlert"><i class="fas fa-check-circle text-green-500 mr-3"></i><p class="text-sm text-green-700"><span class="font-semibold">No ALARA Review Required</span></p></div></div></div></div></div></div>
        <div class="bg-white rounded-lg shadow-md mb-8 overflow-hidden"><div class="bg-blue-700 text-white px-4 py-3 font-semibold flex justify-between items-center cursor-pointer toggle-label" onclick="toggleSection(this)"><h2>Signatures</h2></div><div class="toggle-content"><div><div class="p-6"><div class="grid grid-cols-1 md:grid-cols-2 gap-8"><div class="border border-gray-200 rounded-lg p-4"><h3 class="font-medium text-lg text-gray-800 mb-3">Performed By</h3><div class="space-y-4"><input type="text" placeholder="Name" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm"><input type="date" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm"></div></div><div class="border border-gray-200 rounded-lg p-4"><h3 class="font-medium text-lg text-gray-800 mb-3">Peer Check</h3><div class="space-y-4"><input type="text" placeholder="Name" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm"><input type="date" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm"></div></div></div></div></div></div></div>
    </template>

    <template id="task-template">
        <div class="task-container tab-content-pane printable-section" data-task-id="{taskId}">
            <div class="bg-white rounded-lg shadow-md mb-4 p-4 border-l-4 border-blue-500"><div class="flex justify-between items-center"><div class="flex-grow"><input type="text" id="task-title-{taskId}" name="task-title" class="task-title mt-1 block w-full text-lg font-semibold rounded-md border-gray-300 shadow-sm" placeholder="Write task name here"></div><button class="remove-task-btn ml-4 text-red-500 hover:text-red-700 no-print"><i class="fas fa-trash-alt mr-1"></i>Remove Task</button></div><div class="mt-3"><input type="text" id="task-location-{taskId}" name="task-location" class="task-location block w-full rounded-md border-gray-300 shadow-sm" placeholder="Building and Room Number (e.g., Building 123, Room 456)"></div></div>
            <div class="bg-white rounded-lg shadow-md mb-8 overflow-hidden"><div class="bg-blue-700 text-white px-4 py-3 font-semibold flex justify-between items-center cursor-pointer toggle-label expanded" onclick="toggleSection(this)"><h2>Time Estimation</h2></div><div class="toggle-content expanded"><div><div class="p-6"><div class="grid grid-cols-1 md:grid-cols-4 gap-4"><div><label class="block text-sm font-medium text-gray-700"># Workers</label><input type="number" min="1" value="1" class="workers-count mt-1 block w-full rounded-md border-gray-300 shadow-sm"></div><div><label class="block text-sm font-medium text-gray-700">Hours Each</label><input type="number" min="0" step="0.1" value="1" class="hours-per-worker mt-1 block w-full rounded-md border-gray-300 shadow-sm"></div><div class="md:col-span-2"><label class="block text-sm font-medium text-gray-700">Person-Hours</label><input type="text" class="person-hours mt-1 block w-full rounded-md border-gray-300 shadow-sm bg-gray-50" readonly></div></div></div></div></div></div>
            <div class="bg-white rounded-lg shadow-md mb-8 overflow-hidden"><div class="bg-blue-700 text-white px-4 py-3 font-semibold flex justify-between items-center cursor-pointer toggle-label" onclick="toggleSection(this)"><h2>mPIF Calculation</h2></div><div class="toggle-content"><div><div class="p-6 space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-4">
                    <div><label class="block text-sm font-medium text-gray-700">Release Factor (R)</label><p class="text-xs text-gray-500">Fraction of material that is potentially releasable.</p><select class="mpif-r mt-1 block w-full rounded-md"></select></div>
                    <div><label class="block text-sm font-medium text-gray-700">Confinement Factor (C)</label><p class="text-xs text-gray-500">Effectiveness of confinement barriers.</p><select class="mpif-c mt-1 block w-full rounded-md"></select></div>
                    <div><label class="block text-sm font-medium text-gray-700">Dispersibility Factor (D)</label><p class="text-xs text-gray-500">Set to 10 for actions that add energy (heat, grind, etc.).</p><select class="mpif-d mt-1 block w-full rounded-md border-gray-300 shadow-sm"><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option><option value="6">6</option><option value="7">7</option><option value="8">8</option><option value="9">9</option><option value="10">10</option></select></div>
                    <div><label class="block text-sm font-medium text-gray-700">Special Form Factor (S)</label><p class="text-xs text-gray-500">Set to 0.1 for large particles with poor uptake.</p><select class="mpif-s mt-1 block w-full rounded-md border-gray-300 shadow-sm"><option value="0.1">0.1</option><option value="1">1</option></select></div>
                    <div><label class="block text-sm font-medium text-gray-700">Uncertainty Factor (U)</label><p class="text-xs text-gray-500">Up to 10 if radionuclides are not well known.</p><select class="mpif-u mt-1 block w-full rounded-md border-gray-300 shadow-sm"><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option><option value="6">6</option><option value="7">7</option><option value="8">8</option><option value="9">9</option><option value="10">10</option></select></div>
                    <div class="bg-gray-100 p-3 rounded-md text-center"><label class="block text-sm font-medium">Calculated mPIF (m⁻¹)</label><input type="text" class="mpif-result mt-1 w-full mx-auto block text-center font-bold bg-gray-200 rounded-md" readonly></div>
                </div>
            </div></div></div></div>
            <div class="bg-white rounded-lg shadow-md mb-8 overflow-hidden"><div class="bg-blue-700 text-white px-4 py-3 font-semibold flex justify-between items-center cursor-pointer toggle-label" onclick="toggleSection(this)"><h2>External Dose Estimate</h2></div><div class="toggle-content"><div><div class="p-6"><div class="grid grid-cols-1 md:grid-cols-3 gap-4"><div><label class="block text-sm font-medium text-gray-700">Dose Rate (mrem/hr)</label><input type="number" min="0" step="0.01" value="0" class="dose-rate mt-1 block w-full rounded-md border-gray-300 shadow-sm"></div><div><label class="block text-sm font-medium text-gray-700">Person-Hours</label><input type="text" class="dose-person-hours mt-1 block w-full rounded-md border-gray-300 shadow-sm bg-gray-200" readonly></div><div><label class="block text-sm font-medium text-gray-700">Collective External Dose (mrem)</label><input type="text" class="external-dose-result mt-1 block w-full rounded-md border-gray-300 shadow-sm bg-gray-50" readonly></div></div></div></div></div></div>
            <div class="bg-white rounded-lg shadow-md mb-8 overflow-hidden"><div class="bg-blue-700 text-white px-4 py-3 font-semibold flex justify-between items-center cursor-pointer toggle-label" onclick="toggleSection(this)"><h2>Extremity/Skin Dose Estimate</h2></div><div class="toggle-content"><div><div class="p-6"><div class="extremity-container space-y-4"></div><button class="add-extremity-btn mt-4 inline-flex items-center px-3 py-2 border border-transparent text-sm leading-4 font-medium rounded-md text-purple-700 bg-purple-100 hover:bg-purple-200"><i class="fas fa-plus mr-2"></i>Add Extremity/Skin Dose</button><div class="mt-6 border-t pt-4"><h4 class="text-md font-semibold text-gray-800 mb-2">Extremity/Skin Dose Summary</h4><div class="extremity-summary p-4 bg-gray-50 rounded-lg"><div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm"><div><span class="font-medium text-gray-600">Total Extremity/Skin Dose (mrem):</span><p class="font-semibold task-total-extremity-dose">0.00</p></div><div><span class="font-medium text-gray-600">Individual Extremity/Skin Dose (mrem):</span><p class="font-semibold task-individual-extremity-dose">0.00</p></div></div></div></div></div></div></div></div>
            <div class="bg-white rounded-lg shadow-md mb-8 overflow-hidden"><div class="bg-blue-700 text-white px-4 py-3 font-semibold flex justify-between items-center cursor-pointer toggle-label" onclick="toggleSection(this)"><h2>Protection Factors (For this task)</h2></div><div class="toggle-content"><div><div class="p-6"><div class="grid grid-cols-1 md:grid-cols-2 gap-6"><div class="border border-gray-200 rounded-lg p-4"><h3 class="font-medium text-lg text-gray-800 mb-3">Respiratory (PFR)</h3><div class="space-y-4"><div class="flex items-center"><input name="resp-protection-{taskId}" type="radio" checked class="resp-protection h-4 w-4" value="1"><label class="ml-3 font-medium text-gray-700">None (PFR=1)</label></div><div class="flex items-center"><input name="resp-protection-{taskId}" type="radio" class="resp-protection h-4 w-4" value="50"><label class="ml-3 font-medium text-gray-700">APR (PFR=50)</label></div><div class="flex items-center"><input name="resp-protection-{taskId}" type="radio" class="resp-protection h-4 w-4" value="1000"><label class="ml-3 font-medium text-gray-700">PAPR (PFR=1000)</label></div></div></div><div class="border border-gray-200 rounded-lg p-4"><h3 class="font-medium text-lg text-gray-800 mb-3">Engineering (PFE)</h3><div class="space-y-4"><div class="flex items-center"><input name="eng-control-{taskId}" type="radio" checked class="eng-control h-4 w-4" value="1"><label class="ml-3 font-medium text-gray-700">No Controls (PFE=1)</label></div><div class="flex items-center"><input name="eng-control-{taskId}" type="radio" class="eng-control h-4 w-4" value="1000"><label class="ml-3 font-medium text-gray-700">Type I (PFE=1,000)</label></div><div class="flex items-center"><input name="eng-control-{taskId}" type="radio" class="eng-control h-4 w-4" value="100000"><label class="ml-3 font-medium text-gray-700">Type II (PFE=100,000)</label></div></div></div></div></div></div></div></div>
            <div class="bg-white rounded-lg shadow-md mb-8 overflow-hidden"><div class="bg-blue-700 text-white px-4 py-3 font-semibold flex justify-between items-center cursor-pointer toggle-label" onclick="toggleSection(this)"><h2>Internal Dose Calculation</h2></div><div class="toggle-content"><div><div class="p-6"><div class="nuclides-container space-y-4"></div><button class="add-nuclide-btn mt-4 inline-flex items-center px-3 py-2 border border-transparent text-sm leading-4 font-medium rounded-md text-blue-700 bg-blue-100 hover:bg-blue-200"><i class="fas fa-plus mr-2"></i>Add Nuclide</button><div class="mt-6 border-t pt-4"><h4 class="text-md font-semibold text-gray-800 mb-2">Internal Dose Breakdown</h4><div class="calculation-breakdown p-4 bg-gray-50 rounded-lg grid grid-cols-2 md:grid-cols-4 gap-4 text-sm"></div></div></div></div></div></div>
            <div class="bg-white rounded-lg shadow-md mb-8 p-4 border-t-4 border-green-500"><h3 class="text-lg font-semibold text-gray-800 mb-2">Task Totals</h3><div class="grid grid-cols-1 md:grid-cols-3 gap-4"><div class="bg-gray-100 p-3 rounded-md"><label class="block text-sm font-medium text-gray-700">Collective Effective Dose (mrem)</label><input type="text" class="task-total-effective-dose mt-1 block w-full rounded-md bg-gray-200" readonly></div><div class="bg-green-100 p-3 rounded-md"><label class="block text-sm font-bold text-green-800">Individual Effective Dose (mrem)</label><input type="text" class="task-individual-effective-dose mt-1 block w-full rounded-md bg-green-200 font-bold" readonly></div><div class="bg-purple-100 p-3 rounded-md"><label class="block text-sm font-bold text-purple-800">Individual Extremity/Skin Dose (mrem)</label><input type="text" class="task-individual-extremity-dose-input mt-1 block w-full rounded-md bg-purple-200 font-bold" readonly></div></div></div>
        </div>
    </template>
    
    <template id="nuclide-row-template">
        <div class="nuclide-row border p-4 rounded-lg bg-white">
            <div class="grid grid-cols-1 md:grid-cols-6 gap-4 items-end mb-3">
                <div class="md:col-span-2"><label class="block text-sm font-medium text-gray-700">Nuclide</label><select class="nuclide-select mt-1 block w-full rounded-md border-gray-300 shadow-sm"></select></div>
                <div><label class="block text-sm font-medium text-gray-700">Contam. (dpm/100cm²)</label><input type="number" value="0" step="any" class="nuclide-contam-level mt-1 block w-full rounded-md"></div>
                <div><label class="block text-sm font-medium text-gray-700">DAC (µCi/cm³)</label><input type="text" value="0" class="nuclide-dac mt-1 block w-full bg-gray-200" readonly></div>
                <div><label class="block text-sm font-medium text-gray-700">DAC Fraction (Without Respiratory Protection)</label><input type="text" value="0" class="nuclide-dac-fraction mt-1 block w-full bg-blue-50" readonly></div>
                <button class="remove-nuclide-btn text-red-500 hover:text-red-700 no-print h-10"><i class="fas fa-trash-alt"></i></button>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 bg-gray-50 p-3 rounded">
                <div><label class="block text-sm font-medium text-gray-700">Individual Internal Dose for this Nuclide (mrem)</label><input type="text" value="0" class="nuclide-individual-dose mt-1 block w-full bg-gray-100 font-semibold" readonly></div>
                <div><label class="block text-sm font-medium text-gray-700">Collective Internal Dose for this Nuclide (mrem)</label><input type="text" value="0" class="nuclide-collective-dose mt-1 block w-full bg-gray-100 font-semibold" readonly></div>
            </div>
        </div>
    </template>

    <template id="extremity-row-template">
        <div class="extremity-row border p-4 rounded-lg bg-white">
            <div class="grid grid-cols-1 md:grid-cols-5 gap-4 items-end mb-3">
                <div><label class="block text-sm font-medium text-gray-700">Nuclide</label><select class="extremity-nuclide-select mt-1 block w-full rounded-md border-gray-300 shadow-sm"></select></div>
                <div><label class="block text-sm font-medium text-gray-700">Extremity/Skin Dose Rate (mrem/hr)</label><input type="number" value="0" step="0.01" min="0" class="extremity-dose-rate mt-1 block w-full rounded-md border-gray-300 shadow-sm"></div>
                <div><label class="block text-sm font-medium text-gray-700">Time per Worker (hours)</label><input type="number" value="0" step="0.1" min="0" class="extremity-time-per-worker mt-1 block w-full rounded-md border-gray-300 shadow-sm"></div>
                <div><label class="block text-sm font-medium text-gray-700">Total Dose for this Nuclide (mrem)</label><input type="text" value="0" class="extremity-total-dose mt-1 block w-full bg-gray-100 font-semibold rounded-md" readonly></div>
                <button class="remove-extremity-btn text-red-500 hover:text-red-700 no-print h-10"><i class="fas fa-trash-alt"></i></button>
            </div>
        </div>
    </template>

    <script>
        const DAC_VALUES = {
            "Ac-227": 3e-13, "Ag-108m": 5e-8, "Ag-110m": 3e-8, "Al-26": 2e-9, "Am-241": 5e-12, "Am-243": 5e-12,
            "Ar-37": 4e-5, "Ar-39": 3e-6, "Ar-41": 3e-6, "As-73": 6e-7, "As-74": 2e-7, "As-76": 2e-7, "As-77": 7e-7,
            "At-211": 2e-9, "Au-195": 2e-6, "Au-198": 2e-7, "Au-199": 3e-7, "Ba-131": 3e-7, "Ba-133": 2e-7, "Ba-140": 4e-8,
            "Be-7": 2e-6, "Be-10": 2e-8, "Bi-206": 3e-8, "Bi-207": 4e-8, "Bi-210": 2e-9, "Bi-212": 6e-8, "Bk-249": 2e-9,
            "Br-82": 3e-7, "C-11": 4e-6, "C-14": 2e-7, "Ca-41": 6e-7, "Ca-45": 9e-9, "Ca-47": 9e-8, "Cd-109": 8e-8,
            "Cd-113m": 2e-8, "Cd-115": 3e-7, "Cd-115m": 9e-8, "Ce-139": 2e-7, "Ce-141": 1e-7, "Ce-143": 1e-7, "Ce-144": 2e-9,
            "Cf-249": 3e-12, "Cf-250": 6e-12, "Cf-251": 3e-12, "Cf-252": 2e-11, "Cl-36": 2e-8, "Cl-38": 2e-6, "Cm-242": 2e-11,
            "Cm-243": 6e-12, "Cm-244": 8e-12, "Cm-245": 5e-12, "Cm-246": 5e-12, "Cm-247": 5e-12, "Cm-248": 2e-12,
            "Co-56": 1e-7, "Co-57": 4e-7, "Co-58": 2e-7, "Co-58m": 1e-5, "Co-60": 3e-9, "Co-60m": 3e-4, "Cr-51": 3e-6,
            "Cs-129": 3e-6, "Cs-131": 1e-6, "Cs-134": 2e-8, "Cs-134m": 5e-5, "Cs-135": 3e-7, "Cs-136": 4e-8, "Cs-137": 8e-8,
            "Cu-64": 6e-7, "Cu-67": 3e-7, "Dy-159": 8e-7, "Dy-165": 9e-7, "Dy-166": 3e-8, "Er-169": 1e-6, "Er-171": 4e-7,
            "Eu-152": 6e-9, "Eu-152m": 6e-7, "Eu-154": 5e-9, "Eu-155": 5e-7, "F-18": 1e-6, "Fe-52": 2e-7, "Fe-55": 2e-6,
            "Fe-59": 3e-8, "Ga-67": 1e-6, "Ga-68": 1e-6, "Ga-72": 4e-7, "Gd-146": 4e-8, "Gd-148": 2e-12, "Gd-149": 8e-7,
            "Gd-151": 2e-7, "Gd-153": 6e-7, "Gd-159": 3e-7, "Ge-68": 2e-7, "Ge-71": 2e-5, "H-3": 2e-5, "Hf-172": 1e-8,
            "Hf-175": 2e-7, "Hf-181": 7e-8, "Hg-197": 1e-6, "Hg-197m": 3e-7, "Hg-203": 2e-7, "Ho-166": 3e-8, "I-123": 6e-8,
            "I-124": 1e-8, "I-125": 4e-9, "I-126": 2e-9, "I-129": 6e-9, "I-131": 2e-8, "I-132": 8e-7, "I-133": 7e-8,
            "I-134": 2e-6, "I-135": 3e-7, "In-111": 5e-7, "In-113m": 2e-6, "In-114m": 2e-8, "In-115m": 1e-6, "Ir-190": 2e-7,
            "Ir-192": 2e-8, "Ir-194": 1e-7, "K-40": 3e-8, "K-42": 3e-6, "K-43": 6e-7, "Kr-74": 2e-6, "Kr-76": 8e-7,
            "Kr-77": 2e-6, "Kr-79": 4e-6, "Kr-81": 4e-5, "Kr-81m": 2e-4, "Kr-83m": 5e-4, "Kr-85": 1e-4, "Kr-85m": 3e-5,
            "Kr-87": 8e-6, "Kr-88": 2e-6, "La-137": 3e-7, "La-140": 2e-7, "Lu-172": 6e-8, "Lu-173": 2e-7, "Lu-174": 3e-7,
            "Lu-174m": 2e-7, "Lu-177": 6e-7, "Mn-52": 1e-7, "Mn-53": 5e-6, "Mn-54": 3e-7, "Mn-56": 1e-6, "Mo-93": 3e-7,
            "Mo-99": 2e-7, "N-13": 9e-6, "Na-22": 2e-8, "Na-24": 3e-7, "Nb-93m": 5e-6, "Nb-94": 2e-9, "Nb-95": 2e-7,
            "Nb-97": 9e-7, "Nd-144": 2e-12, "Nd-147": 2e-7, "Nd-149": 6e-7, "Ni-56": 2e-7, "Ni-57": 3e-7, "Ni-59": 2e-6,
            "Ni-63": 2e-7, "Ni-65": 5e-7, "Np-235": 2e-6, "Np-236": 2e-9, "Np-237": 5e-12, "Np-239": 3e-7, "O-15": 2e-6,
            "Os-185": 7e-7, "Os-191": 3e-7, "Os-191m": 4e-6, "Os-193": 2e-7, "P-32": 9e-9, "P-33": 5e-7, "Pa-230": 2e-8,
            "Pa-231": 2e-12, "Pa-233": 2e-7, "Pb-203": 6e-7, "Pb-210": 1e-10, "Pb-212": 8e-10, "Pd-103": 3e-6, "Pd-107": 1e-5,
            "Pd-109": 1e-6, "Pm-143": 2e-7, "Pm-144": 3e-8, "Pm-145": 3e-7, "Pm-147": 3e-7, "Pm-148": 3e-8, "Pm-148m": 4e-8,
            "Pm-149": 4e-7, "Pm-151": 5e-7, "Po-208": 3e-11, "Po-209": 2e-11, "Po-210": 4e-11, "Pr-142": 1e-7, "Pr-143": 2e-7,
            "Pt-191": 3e-7, "Pt-193": 1e-5, "Pt-193m": 1e-6, "Pt-195m": 6e-7, "Pt-197": 6e-7, "Pt-197m": 1e-6, "Pu-236": 2e-11,
            "Pu-237": 3e-6, "Pu-238": 7e-12, "Pu-239": 6e-12, "Pu-240": 6e-12, "Pu-241": 3e-10, "Pu-242": 6e-12, "Pu-244": 6e-12,
            "Ra-223": 9e-11, "Ra-224": 4e-11, "Ra-225": 8e-11, "Ra-226": 3e-11, "Ra-228": 3e-11, "Rb-81": 2e-6, "Rb-82": 6e-6,
            "Rb-83": 2e-6, "Rb-84": 1e-7, "Rb-86": 2e-8, "Rb-87": 3e-7, "Rb-88": 4e-6, "Re-184": 1e-7, "Re-184m": 3e-7,
            "Re-186": 1e-6, "Re-187": 9e-6, "Re-188": 4e-7, "Re-189": 5e-7, "Rh-99": 9e-7, "Rh-101": 4e-7, "Rh-102": 1e-7,
            "Rh-102m": 2e-7, "Rh-103m": 1e-4, "Rh-105": 1e-6, "Rn-220": 3e-8, "Rn-222": 3e-8, "Ru-97": 5e-7, "Ru-103": 3e-7,
            "Ru-105": 5e-7, "Ru-106": 3e-9, "S-35": 2e-7, "Sb-122": 3e-7, "Sb-124": 1e-7, "Sb-125": 2e-7, "Sb-126": 2e-8,
            "Sc-44": 4e-7, "Sc-44m": 2e-7, "Sc-46": 1e-7, "Sc-47": 3e-7, "Sc-48": 1e-7, "Se-72": 3e-7, "Se-73": 4e-7,
            "Se-75": 2e-7, "Se-79": 2e-6, "Si-31": 9e-7, "Si-32": 3e-8, "Sm-145": 3e-7, "Sm-147": 2e-11, "Sm-151": 3e-6,
            "Sm-153": 5e-7, "Sn-113": 2e-7, "Sn-117m": 2e-7, "Sn-119m": 4e-7, "Sn-121": 2e-6, "Sn-121m": 2e-7, "Sn-123": 8e-8,
            "Sn-125": 1e-7, "Sn-126": 1e-8, "Sr-82": 2e-7, "Sr-85": 3e-7, "Sr-85m": 1e-5, "Sr-87m": 3e-5, "Sr-89": 3e-8,
            "Sr-90": 9e-9, "Sr-91": 3e-7, "Sr-92": 1e-6, "Ta-178": 1e-7, "Ta-179": 3e-7, "Ta-182": 4e-8, "Tb-157": 2e-7,
            "Tb-158": 5e-9, "Tb-160": 4e-8, "Tc-94": 1e-6, "Tc-94m": 2e-6, "Tc-95": 1e-6, "Tc-95m": 6e-7, "Tc-96": 2e-7,
            "Tc-96m": 1e-5, "Tc-97": 4e-6, "Tc-97m": 1e-6, "Tc-98": 8e-9, "Tc-99": 2e-6, "Tc-99m": 2e-5, "Te-121": 2e-6,
            "Te-121m": 2e-7, "Te-123": 5e-7, "Te-123m": 2e-7, "Te-125m": 3e-7, "Te-127": 7e-7, "Te-127m": 1e-7, "Te-129": 7e-7,
            "Te-129m": 8e-8, "Te-131": 4e-7, "Te-131m": 1e-7, "Te-132": 2e-7, "Th-227": 8e-12, "Th-228": 2e-12, "Th-229": 5e-13,
            "Th-230": 7e-13, "Th-231": 4e-7, "Th-232": 3e-13, "Th-234": 3e-9, "Ti-44": 2e-9, "Tl-200": 9e-7, "Tl-201": 1e-6,
            "Tl-202": 3e-7, "Tl-204": 2e-7, "Tm-167": 7e-7, "Tm-170": 2e-7, "Tm-171": 8e-7, "U-230": 3e-11, "U-232": 1e-11,
            "U-233": 9e-11, "U-234": 1e-10, "U-235": 8e-11, "U-236": 1e-10, "U-237": 7e-7, "U-238": 1e-10, "U-239": 5e-7,
            "U-240": 3e-7, "V-48": 2e-7, "V-49": 1e-5, "W-178": 9e-6, "W-181": 8e-6, "W-185": 8e-7, "W-187": 2e-6, "W-188": 3e-7,
            "Xe-122": 4e-7, "Xe-123": 2e-7, "Xe-125": 3e-7, "Xe-127": 4e-7, "Xe-129m": 4e-6, "Xe-131m": 1e-5, "Xe-133": 3e-5,
            "Xe-133m": 1e-5, "Xe-135": 1e-5, "Xe-135m": 2e-5, "Xe-138": 1e-5, "Y-86": 1e-7, "Y-87": 2e-7, "Y-88": 1e-7,
            "Y-90": 2e-8, "Y-91": 2e-8, "Y-91m": 2e-5, "Y-92": 2e-7, "Y-93": 1e-7, "Yb-169": 2e-7, "Yb-175": 9e-7,
            "Zn-62": 2e-7, "Zn-63": 9e-7, "Zn-65": 1e-7, "Zn-69": 6e-6, "Zn-69m": 3e-7, "Zr-88": 3e-7, "Zr-89": 1e-7,
            "Zr-93": 5e-8, "Zr-95": 1e-7, "Zr-97": 2e-7, "Other": 2e-13
        };
        const RELEASE_FACTORS = { "Gases, volatile liquids (1.0)": 1.0, "Nonvolatile powders, some liquids (0.1)": 0.1, "Liquids, large area contamination (0.01)": 0.01, "Solids, spotty contamination (0.001)": 0.001, "Encapsulated material (0)": 0 };
        const CONFINEMENT_FACTORS = { "None - Open bench (100)": 100, "Bagged material (10)": 10, "Fume Hood (1.0)": 1.0, "Enhanced Fume Hood (0.1)": 0.1, "Glovebox, Hot Cell (0.01)": 0.01 };
        let taskCounter = 0;
        const mainContentArea = document.getElementById('tab-content-area');

        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('addNewTaskBtn').addEventListener('click', addNewTask);
            document.getElementById('printBtn').addEventListener('click', () => window.print());
            document.getElementById('saveBtn').addEventListener('click', saveStateToFile);
            document.getElementById('loadBtn').addEventListener('click', () => document.getElementById('loadFile').click());
            document.getElementById('loadFile').addEventListener('change', loadStateFromFile);
            mainContentArea.addEventListener('input', handleTaskInput);
            mainContentArea.addEventListener('click', handleTaskClick);
            addSummaryTab();
            switchTab(document.querySelector('.tab-button[data-target="summary-content"]'));
            updateChecklistAlerts();
        });

        function addSummaryTab() {
            const nav = document.getElementById('tab-nav');
            const addNewTaskBtn = document.getElementById('addNewTaskBtn');
            const summaryButton = document.createElement('button');
            summaryButton.className = 'tab-button px-4 py-2 text-sm font-medium rounded-t-lg border-b-2 border-transparent';
            summaryButton.textContent = 'Summary';
            summaryButton.dataset.target = 'summary-content';
            summaryButton.onclick = () => switchTab(summaryButton);
            // Insert before the "Add New Task" button to keep it at the right
            nav.insertBefore(summaryButton, addNewTaskBtn);
            document.getElementById('summary-content').innerHTML = document.getElementById('summary-template').innerHTML;
        }

        function addNewTask(taskData = null) {
            taskCounter++;
            const template = document.getElementById('task-template').content.cloneNode(true);
            const taskContainer = template.querySelector('.task-container');
            taskContainer.dataset.taskId = taskCounter;
            taskContainer.id = `task-content-${taskCounter}`;
            taskContainer.querySelectorAll('[name*="{taskId}"]').forEach(el => el.name = el.name.replace('{taskId}', taskCounter));
            
            const rSelect = taskContainer.querySelector('.mpif-r');
            for (const [text, value] of Object.entries(RELEASE_FACTORS)) { rSelect.add(new Option(text, value)); }
            const cSelect = taskContainer.querySelector('.mpif-c');
            for (const [text, value] of Object.entries(CONFINEMENT_FACTORS)) { cSelect.add(new Option(text, value)); }

            mainContentArea.appendChild(template);
            document.getElementById('empty-state').style.display = 'none';
            const nav = document.getElementById('tab-nav');
            const addNewTaskBtn = document.getElementById('addNewTaskBtn');
            const taskButton = document.createElement('button');
            taskButton.className = 'tab-button task-tab-button px-4 py-2 text-sm font-medium rounded-t-lg border-b-2 border-transparent';

            // Create numbered task text - always add number prefix
            const taskText = (taskData && taskData.title && taskData.title !== `Task ${taskCounter}`)
                ? `${taskCounter}. ${taskData.title}`
                : `${taskCounter}. Task ${taskCounter}`;
            taskButton.textContent = taskText;

            taskButton.dataset.target = `task-content-${taskCounter}`;
            taskButton.onclick = () => switchTab(taskButton);

            // Insert before the "Add New Task" button to keep it at the right
            nav.insertBefore(taskButton, addNewTaskBtn);

            if (taskData) {
                populateTaskData(taskContainer, taskData);
            } else {
                addNuclideRow(taskContainer.querySelector('.add-nuclide-btn'));
            }

            switchTab(taskButton);
            calculateTaskTotals(taskContainer);
        }
        
        function populateTaskData(taskContainer, taskData) {
            const setValue = (selector, value) => {
                const el = taskContainer.querySelector(selector);
                if (el) el.value = value;
            };
            const setRadio = (name, value) => {
                const el = taskContainer.querySelector(`input[name^="${name}"][value="${value}"]`);
                if (el) el.checked = true;
            };
            
            setValue('.task-title', taskData.title || '');
            setValue('.task-location', taskData.location || '');
            setValue('.workers-count', taskData.workers);
            setValue('.hours-per-worker', taskData.hours);
            setValue('.mpif-r', taskData.mpifR);
            setValue('.mpif-c', taskData.mpifC);
            setValue('.mpif-d', taskData.mpifD);
            setValue('.mpif-s', taskData.mpifS);
            setValue('.mpif-u', taskData.mpifU);
            setValue('.dose-rate', taskData.doseRate);
            setRadio('resp-protection', taskData.pfr);
            setRadio('eng-control', taskData.pfe);

            taskData.nuclides.forEach(nuclideData => {
                addNuclideRow(taskContainer.querySelector('.add-nuclide-btn'), nuclideData);
            });

            // Restore extremity dose data
            if (taskData.extremityDoses) {
                taskData.extremityDoses.forEach(extremityData => {
                    addExtremityRow(taskContainer.querySelector('.add-extremity-btn'), extremityData);
                });
            }
        }

        function addNuclideRow(button, nuclideData = null) {
            const nuclidesContainer = button.previousElementSibling;
            const template = document.getElementById('nuclide-row-template').content.cloneNode(true);
            const select = template.querySelector('.nuclide-select');
            Object.keys(DAC_VALUES).forEach(nuclide => {
                const option = document.createElement('option');
                option.value = nuclide; option.textContent = nuclide;
                select.appendChild(option);
            });
            select.addEventListener('change', (e) => {
                const dacInput = e.target.closest('.nuclide-row').querySelector('.nuclide-dac');
                dacInput.value = DAC_VALUES[e.target.value].toExponential(2);
                dacInput.readOnly = e.target.value !== 'Other';
                calculateTaskTotals(e.target.closest('.task-container'));
            });
            
            if (nuclideData) {
                select.value = nuclideData.name;
                template.querySelector('.nuclide-contam-level').value = nuclideData.contam;
            }

            select.dispatchEvent(new Event('change'));
            nuclidesContainer.appendChild(template);
            calculateTaskTotals(button.closest('.task-container'));
        }

        function addExtremityRow(button, extremityData = null) {
            const extremityContainer = button.previousElementSibling;
            const template = document.getElementById('extremity-row-template').content.cloneNode(true);
            const select = template.querySelector('.extremity-nuclide-select');

            // Populate with same nuclides as internal dose
            Object.keys(DAC_VALUES).forEach(nuclide => {
                const option = document.createElement('option');
                option.value = nuclide;
                option.textContent = nuclide;
                select.appendChild(option);
            });

            // Add event listeners for calculation
            const doseRateInput = template.querySelector('.extremity-dose-rate');
            const timeInput = template.querySelector('.extremity-time-per-worker');

            [doseRateInput, timeInput].forEach(input => {
                input.addEventListener('input', () => {
                    calculateExtremityDose(input.closest('.extremity-row'));
                    calculateTaskTotals(input.closest('.task-container'));
                });
            });

            if (extremityData) {
                select.value = extremityData.nuclide;
                doseRateInput.value = extremityData.doseRate;
                timeInput.value = extremityData.time;
            }

            extremityContainer.appendChild(template);
            calculateExtremityDose(extremityContainer.lastElementChild);
            calculateTaskTotals(button.closest('.task-container'));
        }

        function calculateExtremityDose(extremityRow) {
            const doseRate = parseFloat(extremityRow.querySelector('.extremity-dose-rate').value) || 0;
            const time = parseFloat(extremityRow.querySelector('.extremity-time-per-worker').value) || 0;
            const totalDose = doseRate * time;

            extremityRow.querySelector('.extremity-total-dose').value = totalDose.toFixed(2);
        }

        function removeTask(button) {
            const taskContainer = button.closest('.task-container');
            const tabButton = document.querySelector(`.tab-button[data-target="${taskContainer.id}"]`);
            switchTab(document.querySelector('.tab-button[data-target="summary-content"]'));
            taskContainer.remove();
            tabButton.remove();
            renumberTasks();
            if (document.querySelectorAll('.task-container').length === 0) document.getElementById('empty-state').style.display = 'block';
            updateSummary();
        }

        function renumberTasks() {
            document.querySelectorAll('.task-container').forEach((task, index) => {
                const newId = index + 1;
                const oldId = task.dataset.taskId;

                // Update task container
                task.dataset.taskId = newId;
                task.id = `task-content-${newId}`;

                // Update tab button
                const tabButton = document.querySelector(`.tab-button[data-target="task-content-${oldId}"]`);
                if(tabButton) {
                    tabButton.dataset.target = `task-content-${newId}`;

                    // Update tab text with proper numbering
                    const taskTitle = task.querySelector('.task-title').value || `Task ${newId}`;
                    tabButton.textContent = `${newId}. ${taskTitle}`;
                }

                // Update all form element names and IDs that contain the old task ID
                task.querySelectorAll('[name*="-'+ oldId +'"]').forEach(el => {
                    el.name = el.name.replace('-'+oldId, '-'+newId);
                });
                task.querySelectorAll('[id*="-'+ oldId +'"]').forEach(el => {
                    el.id = el.id.replace('-'+oldId, '-'+newId);
                });
            });
            taskCounter = document.querySelectorAll('.task-container').length;
        }

        function switchTab(button) {
            if (!button) return;
            document.querySelectorAll('.tab-content-pane').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
            document.getElementById(button.dataset.target)?.classList.add('active');
            button.classList.add('active');
        }

        function handleTaskInput(event) {
            const taskContainer = event.target.closest('.task-container');
            if (taskContainer) {
                // No longer need to clamp mPIF inputs since they're now dropdowns

                calculateTaskTotals(taskContainer);
                if (event.target.matches('.task-title')) {
                    const tabButton = document.querySelector(`.tab-button[data-target="${taskContainer.id}"]`);
                    if (tabButton) {
                        const taskId = taskContainer.dataset.taskId;
                        const taskTitle = event.target.value || `Task ${taskId}`;
                        tabButton.textContent = `${taskId}. ${taskTitle}`;
                    }
                }
            }
        }

        function handleTaskClick(event) {
            const button = event.target.closest('button');
            if (!button) return;
            if (button.matches('.remove-task-btn')) removeTask(button);
            if (button.matches('.add-nuclide-btn')) addNuclideRow(button);
            if (button.matches('.remove-nuclide-btn')) {
                const taskContainer = button.closest('.task-container');
                button.closest('.nuclide-row').remove();
                calculateTaskTotals(taskContainer);
            }
            if (button.matches('.add-extremity-btn')) addExtremityRow(button);
            if (button.matches('.remove-extremity-btn')) {
                const taskContainer = button.closest('.task-container');
                button.closest('.extremity-row').remove();
                calculateTaskTotals(taskContainer);
            }
        }
        
        function toggleSection(header) {
            header.classList.toggle('expanded');
            header.nextElementSibling.classList.toggle('expanded');
        }

        function calculateTaskTotals(task) {
            const getVal = (selector) => parseFloat(task.querySelector(selector)?.value) || 0;
            const getRadio = (name) => parseFloat(task.querySelector(`input[name^="${name}"]:checked`)?.value) || 1;
            const setVal = (selector, val, format) => {
                const el = task.querySelector(selector);
                if (el) el.value = format === 'exp' ? val.toExponential(2) : val.toFixed(2);
            };
            const setHTML = (selector, html) => {
                const el = task.querySelector(selector);
                if(el) el.innerHTML = html;
            }

            const workers = getVal('.workers-count');
            const hours = getVal('.hours-per-worker');
            const personHours = workers * hours;
            setVal('.person-hours', personHours, 'fixed');
            setVal('.dose-person-hours', personHours, 'fixed');

            const mPIF = 1e-6 * getVal('.mpif-r') * getVal('.mpif-c') * getVal('.mpif-d') * 1 * getVal('.mpif-s') * getVal('.mpif-u');
            setVal('.mpif-result', mPIF, 'exp');
            
            const rate = getVal('.dose-rate');
            const collectiveExternalDose = rate * personHours;
            setVal('.external-dose-result', collectiveExternalDose, 'fixed');

            const pfr = getRadio('resp-protection');
            const pfe = getRadio('eng-control');
            let totalDacFraction = 0;
            let totalCollectiveInternal = 0;

            task.querySelectorAll('.nuclide-row').forEach(row => {
                const contamLevel = parseFloat(row.querySelector('.nuclide-contam-level').value) || 0;
                const dac = parseFloat(row.querySelector('.nuclide-dac').value) || 1e-12;
                const airConc = (contamLevel / 100) * mPIF * (1/100) * (1 / 2.22e6);
                const dacFractionRaw = (airConc / dac);
                const dacFraction = dacFractionRaw / pfe;
                const nuclideDose = dacFraction * (personHours / 2000) * 5000 / pfr;
                const nuclideIndividualDose = workers > 0 ? nuclideDose / workers : 0;

                totalDacFraction += dacFraction;
                totalCollectiveInternal += nuclideDose;

                row.querySelector('.nuclide-dac-fraction').value = dacFraction.toExponential(2);
                row.querySelector('.nuclide-individual-dose').value = nuclideIndividualDose.toExponential(2);
                row.querySelector('.nuclide-collective-dose').value = nuclideDose.toExponential(2);
            });

            const breakdownHTML = `
                <div><span class="font-medium text-gray-600">Total DAC Fraction:</span><p class="font-semibold">${totalDacFraction.toExponential(2)}</p></div>
                <div><span class="font-medium text-gray-600">PFR:</span><p class="font-semibold">${pfr}</p></div>
                <div><span class="font-medium text-gray-600">PFE:</span><p class="font-semibold">${pfe}</p></div>
                <div class="md:col-span-2 bg-blue-100 p-2 rounded-md"><span class="font-medium text-blue-800">Total Collective Internal Dose (mrem):</span><p class="font-bold text-blue-800">${totalCollectiveInternal.toExponential(2)}</p></div>
            `;
            setHTML('.calculation-breakdown', breakdownHTML);
            
            const collectiveEffectiveDose = collectiveExternalDose + totalCollectiveInternal;
            setVal('.task-total-effective-dose', collectiveEffectiveDose, 'fixed');

            const individualEffectiveDose = workers > 0 ? collectiveEffectiveDose / workers : 0;
            setVal('.task-individual-effective-dose', individualEffectiveDose, 'fixed');

            // Calculate extremity/skin dose totals
            let totalExtremityDose = 0;
            task.querySelectorAll('.extremity-row').forEach(row => {
                const extremityDose = parseFloat(row.querySelector('.extremity-total-dose').value) || 0;
                totalExtremityDose += extremityDose;
            });

            // Update extremity dose summary
            const extremitySummary = task.querySelector('.extremity-summary');
            if (extremitySummary) {
                extremitySummary.querySelector('.task-total-extremity-dose').textContent = totalExtremityDose.toFixed(2);
                extremitySummary.querySelector('.task-individual-extremity-dose').textContent = totalExtremityDose.toFixed(2);
            }

            // Update task totals input
            setVal('.task-individual-extremity-dose-input', totalExtremityDose, 'fixed');

            updateSummary();
        }

        function updateSummary() {
            const tasks = document.querySelectorAll('.task-container');
            const summaryBody = document.getElementById('summary-table-body');
            summaryBody.innerHTML = '';
            let totalIndividualEffectiveDose = 0;

            if (tasks.length === 0) {
                summaryBody.innerHTML = '<tr id="no-tasks-row"><td colspan="9" class="px-4 py-4 text-center text-gray-500">No tasks added.</td></tr>';
            } else {
                tasks.forEach((task, index) => {
                    const taskTitle = task.querySelector('.task-title').value || `Write task name here`;
                    const taskLocation = task.querySelector('.task-location').value || '';
                    const workers = parseFloat(task.querySelector('.workers-count').value) || 0;
                    
                    const collectiveExternal = parseFloat(task.querySelector('.external-dose-result').value) || 0;
                    const collectiveInternal = parseFloat(task.querySelector('.calculation-breakdown').textContent.match(/Total Collective Internal Dose.*?(\d+\.\d+[Ee][+-]\d+)/)?.[1]) || 0;

                    const pfr = parseFloat(task.querySelector('input[name^="resp-protection"]:checked').value) || 1;
                    const pfe = parseFloat(task.querySelector('input[name^="eng-control"]:checked').value) || 1;
                    const hours = parseFloat(task.querySelector('.hours-per-worker').value) || 0;
                    const mPIF = parseFloat(task.querySelector('.mpif-result').value) || 0;
                    let totalDacFraction = 0;
                    task.querySelectorAll('.nuclide-row').forEach(row => {
                        const contamLevel = parseFloat(row.querySelector('.nuclide-contam-level').value) || 0;
                        const dac = parseFloat(row.querySelector('.nuclide-dac').value) || 1e-12;
                        const airConc = (contamLevel / 100) * mPIF * (1/100) * (1 / 2.22e6);
                        const dacFractionRaw = (airConc / dac);
                        const dacFraction = dacFractionRaw / pfe;
                        totalDacFraction += dacFraction;
                    });

                    const individualExternal = workers > 0 ? collectiveExternal / workers : 0;
                    const individualInternal = workers > 0 ? collectiveInternal / workers : 0;
                    const individualExtremity = parseFloat(task.querySelector('.task-individual-extremity-dose-input').value) || 0;
                    const individualTotal = individualExternal + individualInternal;

                    totalIndividualEffectiveDose += individualTotal;

                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td class="px-4 py-2 text-sm font-medium text-gray-900">${taskTitle}</td>
                        <td class="px-4 py-2 text-sm text-gray-500">${taskLocation}</td>
                        <td class="px-4 py-2 text-sm text-gray-500">${workers}</td>
                        <td class="px-4 py-2 text-sm text-gray-500">${totalDacFraction.toExponential(2)}</td>
                        <td class="px-4 py-2 text-sm text-gray-500">${individualExternal.toFixed(2)}</td>
                        <td class="px-4 py-2 text-sm text-gray-500">${individualInternal.toExponential(2)}</td>
                        <td class="px-4 py-2 text-sm text-gray-500">${individualExtremity.toFixed(2)}</td>
                        <td class="px-4 py-2 text-sm text-gray-500">${collectiveExternal.toFixed(2)}</td>
                        <td class="px-4 py-2 text-sm text-gray-500">${collectiveInternal.toExponential(2)}</td>
                        <td class="px-4 py-2 text-sm font-semibold">${individualTotal.toFixed(2)}</td>`;
                    summaryBody.appendChild(row);
                });
            }

            // Calculate total extremity dose across all tasks
            let totalIndividualExtremityDose = 0;
            tasks.forEach(task => {
                const individualExtremity = parseFloat(task.querySelector('.task-individual-extremity-dose-input').value) || 0;
                totalIndividualExtremityDose += individualExtremity;
            });

            document.getElementById('total-individual-dose-per-worker').value = totalIndividualEffectiveDose.toFixed(2);
            document.getElementById('total-individual-extremity-dose-per-worker').value = totalIndividualExtremityDose.toFixed(2);

            const alaraCheck2 = document.getElementById('alara-2');
            if (alaraCheck2) alaraCheck2.checked = totalIndividualEffectiveDose > 500;

            // Check ALARA trigger for extremity dose > 5000 mrem
            const alaraCheck3 = document.getElementById('alara-3');
            if (alaraCheck3) alaraCheck3.checked = totalIndividualExtremityDose > 5000;

            // Calculate total collective dose across all tasks and check ALARA trigger > 750 person-mrem
            let totalCollectiveDose = 0;
            tasks.forEach(task => {
                const collectiveDose = parseFloat(task.querySelector('.task-total-effective-dose').value) || 0;
                totalCollectiveDose += collectiveDose;
            });
            const alaraCheck4 = document.getElementById('alara-4');
            if (alaraCheck4) alaraCheck4.checked = totalCollectiveDose > 750;

            let maxDacHrs = 0;
            let maxDacSpike = 0;
            let maxDacHrsEngOnly = 0; // For ALARA trigger (engineering controls only)
            let maxContamination = 0;
            let maxDoseRate = 0;
            let maxTaskDacAvgOver40 = 0;

            tasks.forEach(task => {
                const hours = parseFloat(task.querySelector('.hours-per-worker').value) || 0;
                const mPIF = parseFloat(task.querySelector('.mpif-result').value) || 0;
                const doseRate = parseFloat(task.querySelector('.dose-rate').value) || 0;
                const pfr = parseFloat(task.querySelector('input[name^="resp-protection"]:checked').value) || 1;
                const pfe = parseFloat(task.querySelector('input[name^="eng-control"]:checked').value) || 1;

                maxDoseRate = Math.max(maxDoseRate, doseRate);

                let taskDacFractionWithRespProtection = 0;
                let taskDacFractionEngOnly = 0;

                task.querySelectorAll('.nuclide-row').forEach(row => {
                    const contamLevel = parseFloat(row.querySelector('.nuclide-contam-level').value) || 0;
                    const dac = parseFloat(row.querySelector('.nuclide-dac').value) || 1e-12;
                    const airConc = (contamLevel / 100) * mPIF * (1/100) * (1 / 2.22e6);

                    // For DAC-hrs calculation: include both engineering and respiratory protection (what worker actually breathes)
                    const dacFractionWithBothProtections = (airConc / dac) / (pfe * pfr);
                    taskDacFractionWithRespProtection += dacFractionWithBothProtections;

                    // For 0.3 DAC average calculation: only engineering controls
                    const dacFractionEngOnly = (airConc / dac) / pfe;
                    taskDacFractionEngOnly += dacFractionEngOnly;

                    maxContamination = Math.max(maxContamination, contamLevel / 1000);
                });

                // DAC-hrs calculation (with respiratory protection - what worker actually breathes)
                const dacHrs = taskDacFractionWithRespProtection * hours;
                maxDacHrs = Math.max(maxDacHrs, dacHrs);

                // Spike calculation (engineering controls only)
                maxDacSpike = Math.max(maxDacSpike, taskDacFractionEngOnly);

                // DAC-hrs calculation for ALARA trigger (engineering controls only, no respiratory protection)
                const dacHrsEngOnly = taskDacFractionEngOnly * hours;
                maxDacHrsEngOnly = Math.max(maxDacHrsEngOnly, dacHrsEngOnly);

                // Calculate this task's DAC-hours averaged over 40 hours
                const taskDacHours = taskDacFractionEngOnly * hours;
                const taskDacAvgOver40 = taskDacHours / 40; // Average over 40 hours
                maxTaskDacAvgOver40 = Math.max(maxTaskDacAvgOver40, taskDacAvgOver40);
            });


            const alaraCheck5 = document.getElementById('alara-5');
            if (alaraCheck5) alaraCheck5.checked = maxDacHrsEngOnly > 200 || maxDacSpike > 1000;

            const alaraCheck6 = document.getElementById('alara-6');
            if (alaraCheck6) alaraCheck6.checked = maxContamination > 1;

            const alaraCheck8 = document.getElementById('alara-8');
            if (alaraCheck8) alaraCheck8.checked = maxDoseRate > 10000;

            // Calculate total internal dose only for ALARA trigger (exclude external dose)
            let totalInternalDoseOnly = 0;
            tasks.forEach(task => {
                const collectiveInternal = parseFloat(task.querySelector('.calculation-breakdown').textContent.match(/Total Collective Internal Dose.*?(\d+\.\d+[Ee][+-]\d+)/)?.[1]) || 0;
                const workers = parseFloat(task.querySelector('.workers-count').value) || 1;
                const individualInternal = workers > 0 ? collectiveInternal / workers : 0;
                totalInternalDoseOnly += individualInternal;
            });

            const alaraCheck7 = document.getElementById('alara-7');
            if (alaraCheck7) alaraCheck7.checked = totalInternalDoseOnly > 100;

            // Air sampling trigger checks
            const sampling1 = document.getElementById('sampling-1');
            if (sampling1) sampling1.checked = maxDacHrs > 40;

            const sampling5 = document.getElementById('sampling-5');
            // Check for two conditions:
            // 1. Maximum task DAC-hours averaged over 40 hours > 0.3 DAC
            // 2. Any task > 1 DAC at any time (spike)
            const condition1 = maxTaskDacAvgOver40 > 0.3;
            const condition2 = maxDacSpike > 1.0;
            const sampling5Triggered = condition1 || condition2;
            if (sampling5) sampling5.checked = sampling5Triggered;

            // Auto-check sampling-7 (de-post ARA) if sampling-5 is triggered
            const sampling7 = document.getElementById('sampling-7');
            if (sampling7) sampling7.checked = sampling5Triggered;

            // Check if any task uses respiratory protection (APR or PAPR)
            let respiratoryProtectionUsed = false;
            tasks.forEach(task => {
                const pfr = parseFloat(task.querySelector('input[name^="resp-protection"]:checked').value) || 1;
                if (pfr > 1) { // APR=50 or PAPR=1000, both > 1
                    respiratoryProtectionUsed = true;
                }
            });
            const sampling2 = document.getElementById('sampling-2');
            if (sampling2) sampling2.checked = respiratoryProtectionUsed;

            // Check if any individual internal dose exceeds 500 mrem (10% of ALI)
            let individualInternalDoseExceeds500 = false;
            tasks.forEach(task => {
                const collectiveInternal = parseFloat(task.querySelector('.calculation-breakdown').textContent.match(/Total Collective Internal Dose.*?(\d+\.\d+[Ee][+-]\d+)/)?.[1]) || 0;
                const workers = parseFloat(task.querySelector('.workers-count').value) || 1;
                const individualInternalDose = workers > 0 ? collectiveInternal / workers : 0;
                if (individualInternalDose > 500) {
                    individualInternalDoseExceeds500 = true;
                }
            });
            const sampling4 = document.getElementById('sampling-4');
            if (sampling4) sampling4.checked = individualInternalDoseExceeds500;

            // Check if any worker receives more than 40 DAC-hours in a week (CAMS trigger)
            // For a 40-hour work week, we need to check if any single task's DAC-hours > 40
            let camsRequired = false;
            tasks.forEach(task => {
                const hours = parseFloat(task.querySelector('.hours-per-worker').value) || 0;
                const pfr = parseFloat(task.querySelector('input[name^="resp-protection"]:checked').value) || 1;
                const pfe = parseFloat(task.querySelector('input[name^="eng-control"]:checked').value) || 1;

                let taskDacFractionWithRespProtection = 0;
                task.querySelectorAll('.nuclide-row').forEach(row => {
                    const contamLevel = parseFloat(row.querySelector('.nuclide-contam-level').value) || 0;
                    const dac = parseFloat(row.querySelector('.nuclide-dac').value) || 1e-12;
                    const mPIF = parseFloat(task.querySelector('.mpif-result').value) || 0;
                    const airConc = (contamLevel / 100) * mPIF * (1/100) * (1 / 2.22e6);
                    const dacFractionWithBothProtections = (airConc / dac) / (pfe * pfr);
                    taskDacFractionWithRespProtection += dacFractionWithBothProtections;
                });

                const taskDacHours = taskDacFractionWithRespProtection * hours;
                if (taskDacHours > 40) {
                    camsRequired = true;
                }
            });
            const camsTrigger = document.getElementById('cams-trigger');
            if (camsTrigger) camsTrigger.checked = camsRequired;

            updateChecklistAlerts();
        }
        
        function updateChecklistAlerts() {
            const airSamplingNeeded = Array.from(document.querySelectorAll('.air-sampling-check')).some(c => c.checked);
            const airSamplingAlert = document.getElementById('airSamplingAlert');
            if(airSamplingAlert) {
                airSamplingAlert.style.display = airSamplingNeeded ? 'flex' : 'none';
                document.getElementById('noAirSamplingAlert').style.display = airSamplingNeeded ? 'none' : 'flex';
            }
            const alaraReviewNeeded = Array.from(document.querySelectorAll('.alara-check')).some(c => c.checked);
            const alaraAlert = document.getElementById('alaraAlert');
            if(alaraAlert) {
                alaraAlert.style.display = alaraReviewNeeded ? 'flex' : 'none';
                document.getElementById('noAlaraAlert').style.display = alaraReviewNeeded ? 'none' : 'flex';
            }
        }

        // --- SAVE/LOAD FUNCTIONALITY ---
        function saveStateToFile() {
            const state = {
                projectInfo: {},
                tasks: []
            };

            document.querySelectorAll('.project-info').forEach(el => {
                state.projectInfo[el.id] = el.value;
            });

            document.querySelectorAll('.task-container').forEach(task => {
                const taskData = {
                    title: task.querySelector('.task-title').value,
                    location: task.querySelector('.task-location').value,
                    workers: task.querySelector('.workers-count').value,
                    hours: task.querySelector('.hours-per-worker').value,
                    mpifR: task.querySelector('.mpif-r').value,
                    mpifC: task.querySelector('.mpif-c').value,
                    mpifD: task.querySelector('.mpif-d').value,
                    mpifS: task.querySelector('.mpif-s').value,
                    mpifU: task.querySelector('.mpif-u').value,
                    doseRate: task.querySelector('.dose-rate').value,
                    pfr: task.querySelector('input[name^="resp-protection"]:checked').value,
                    pfe: task.querySelector('input[name^="eng-control"]:checked').value,
                    nuclides: []
                };
                task.querySelectorAll('.nuclide-row').forEach(row => {
                    taskData.nuclides.push({
                        name: row.querySelector('.nuclide-select').value,
                        contam: row.querySelector('.nuclide-contam-level').value
                    });
                });

                // Save extremity dose data
                taskData.extremityDoses = [];
                task.querySelectorAll('.extremity-row').forEach(row => {
                    taskData.extremityDoses.push({
                        nuclide: row.querySelector('.extremity-nuclide-select').value,
                        doseRate: row.querySelector('.extremity-dose-rate').value,
                        time: row.querySelector('.extremity-time-per-worker').value
                    });
                });

                state.tasks.push(taskData);
            });

            const blob = new Blob([JSON.stringify(state, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'dose-estimate.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function loadStateFromFile(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                const state = JSON.parse(e.target.result);
                
                // Clear existing state
                document.querySelectorAll('.task-container').forEach(t => t.remove());
                document.querySelectorAll('.tab-button:not([data-target="summary-content"])').forEach(b => b.remove());
                taskCounter = 0;
                
                // Load project info
                for (const [id, value] of Object.entries(state.projectInfo)) {
                    const el = document.getElementById(id);
                    if (el) el.value = value;
                }

                // Load tasks
                state.tasks.forEach(taskData => {
                    addNewTask(taskData);
                });

                if(state.tasks.length === 0) {
                     document.getElementById('empty-state').style.display = 'block';
                }

                updateSummary();
            };
            reader.readAsText(file);
        }

    </script>
</body>
</html>
